name: Coverage Gate

on:
  pull_request:
    branches: [master]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/ISSUE_TEMPLATE/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      QT_QPA_PLATFORM: offscreen
      COVERAGE_THRESHOLD: "80"
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libegl1
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: requirements.txt
      - name: Stabilization rules
        run: python3 scripts/check_stabilization_rules.py
      - run: pip install -r requirements.txt pytest pytest-cov pytest-timeout PyQt6
      - name: Run tests with coverage
        continue-on-error: true
        run: |
          PYTHONPATH=loofi-fedora-tweaks python -m pytest tests/ \
            --cov=loofi-fedora-tweaks \
            --cov-report=json:coverage.json \
            --timeout=60 -q
      - name: Comment coverage on PR
        if: ${{ always() }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const cov = JSON.parse(fs.readFileSync('coverage.json'));
              const threshold = parseInt('${{ env.COVERAGE_THRESHOLD }}');
              const pct = cov.totals.percent_covered.toFixed(1);
              const status = parseFloat(pct) >= threshold ? 'âœ…' : 'âŒ';
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `## ğŸ“Š Coverage Report\n\n${status} **Total coverage: ${pct}%**\n\nThreshold: ${threshold}%`
              });
            } catch (e) {
              console.log('Could not parse coverage report:', e.message);
            }
