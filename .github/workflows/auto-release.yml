name: Auto Release Pipeline

on:
  push:
    branches:
      - master
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version without v prefix (example: 25.0.1). Required for manual release runs."
        required: false
      dry_run:
        description: "Dry run (validate/build only, skip tag/release publish)."
        type: boolean
        default: false

permissions:
  contents: read
  checks: write

concurrency:
  group: auto-release-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  COVERAGE_THRESHOLD: "80"
  PIP_CACHE_FILES: |
    requirements.txt
    .github/workflows/auto-release.yml

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: ${{ env.PIP_CACHE_FILES }}

      - name: Resolve version and tag
        id: version
        run: |
          PY_VER=$(python -c "import sys; sys.path.insert(0,'loofi-fedora-tweaks'); from version import __version__; print(__version__)")
          echo "version=${PY_VER}" >> "$GITHUB_OUTPUT"
          echo "tag=v${PY_VER}" >> "$GITHUB_OUTPUT"

      - name: Validate manual release version input
        if: github.event_name == 'workflow_dispatch' && inputs.version != ''
        run: |
          INPUT_VER="${{ inputs.version }}"
          CODE_VER="${{ steps.version.outputs.version }}"
          if [ "$INPUT_VER" != "$CODE_VER" ]; then
            echo "::error::workflow_dispatch version '$INPUT_VER' does not match code version '$CODE_VER'"
            exit 1
          fi

      - name: Validate version alignment
        run: |
          PY_VER="${{ steps.version.outputs.version }}"
          SPEC_VER=$(grep '^Version:' loofi-fedora-tweaks.spec | awk '{print $2}')

          echo "version.py: $PY_VER"
          echo ".spec: $SPEC_VER"

          if [ "$PY_VER" != "$SPEC_VER" ]; then
            echo "::error::Version mismatch! version.py=$PY_VER, .spec=$SPEC_VER"
            exit 1
          fi

          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            TAG_VER="${GITHUB_REF#refs/tags/v}"
            if [ "$PY_VER" != "$TAG_VER" ]; then
              echo "::error::Tag version ($TAG_VER) doesn't match code ($PY_VER)"
              exit 1
            fi
          fi

      - name: Generate workflow reports if missing
        if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
        run: |
          python3 scripts/generate_workflow_reports.py --check || \
            python3 scripts/generate_workflow_reports.py --skip-tests

      - name: Validate workflow logs for release events
        if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
        run: python3 scripts/check_release_docs.py --require-logs

      - name: Validate packaging scripts
        run: |
          for script in scripts/build_rpm.sh scripts/build_flatpak.sh scripts/build_sdist.sh; do
            if [ -f "$script" ]; then
              echo "✓ $script exists"
              if [ -x "$script" ]; then
                echo "  ✓ executable"
              else
                echo "::error::$script exists but is not executable"
                exit 1
              fi
            else
              echo "::error::$script missing"
              exit 1
            fi
          done

  adapter_drift:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: ${{ env.PIP_CACHE_FILES }}
      - run: python3 scripts/sync_ai_adapters.py --check

  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: ${{ env.PIP_CACHE_FILES }}
      - run: pip install flake8
      - run: flake8 loofi-fedora-tweaks/ --max-line-length=150 --ignore=E501,W503,E402,E722,E203

  typecheck:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: ${{ env.PIP_CACHE_FILES }}
      - run: pip install mypy PyQt6-stubs
      - run: mypy loofi-fedora-tweaks/ --ignore-missing-imports --no-error-summary --warn-return-any

  stabilization_rules:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: python3 scripts/check_stabilization_rules.py

  docs_gate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: ${{ env.PIP_CACHE_FILES }}
      - run: python3 scripts/check_release_docs.py

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      QT_QPA_PLATFORM: offscreen
    steps:
      - uses: actions/checkout@v4
      - name: Install system test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libegl1
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: ${{ env.PIP_CACHE_FILES }}
      - run: pip install -r requirements.txt pytest pytest-cov pytest-timeout PyQt6
      - run: python loofi-fedora-tweaks/main.py --version
      - run: python loofi-fedora-tweaks/main.py --cli --version
      - name: Run tests
        id: run_tests
        continue-on-error: true
        run: |
          PYTHONPATH=loofi-fedora-tweaks python -m pytest tests/ -v \
            --tb=short \
            --timeout=60 \
            --cov=loofi-fedora-tweaks \
            --cov-report=term-missing \
            --junitxml=test-results.xml
      - name: Check coverage threshold
        run: |
          PYTHONPATH=loofi-fedora-tweaks python -m coverage report \
            --fail-under=${{ env.COVERAGE_THRESHOLD }}
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.xml
      - name: Test report annotations
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results
          path: test-results.xml
          reporter: java-junit
          fail-on-error: false

  security:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: ${{ env.PIP_CACHE_FILES }}
      - run: pip install bandit
      - run: bandit -r loofi-fedora-tweaks/ -ll -ii --skip B103,B104,B108,B310,B404,B603,B602 -f json -o bandit-report.json
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: bandit-report.json

  build:
    runs-on: ubuntu-latest
    container: fedora:43
    timeout-minutes: 20
    needs: [validate, adapter_drift, lint, typecheck, stabilization_rules, docs_gate, test, security]
    if: |
      !cancelled() &&
      needs.validate.result == 'success' &&
      needs.adapter_drift.result == 'success' &&
      needs.lint.result == 'success' &&
      needs.typecheck.result == 'success' &&
      needs.stabilization_rules.result == 'success' &&
      needs.test.result == 'success' &&
      needs.docs_gate.result == 'success' &&
      needs.security.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - name: Install build deps
        run: dnf install -y rpm-build python3 python3-devel desktop-file-utils systemd-rpm-macros
      - name: Build RPM
        run: bash scripts/build_rpm.sh
      - uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: rpmbuild/RPMS/noarch/*.rpm
          if-no-files-found: error

  rpm_smoke_test:
    runs-on: ubuntu-latest
    container: fedora:43
    timeout-minutes: 10
    needs: [build]
    if: |
      !cancelled() &&
      needs.build.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - name: Download RPM artifact
        uses: actions/download-artifact@v4
        with:
          name: rpm-package
          path: rpm-install
      - name: Install RPM
        run: |
          dnf install -y ./rpm-install/*.rpm
      - name: Smoke test — verify binary exists
        run: |
          command -v loofi-fedora-tweaks || { echo "::error::Binary not found after RPM install"; exit 1; }
      - name: Smoke test — version output
        run: |
          loofi-fedora-tweaks --version
      - name: Smoke test — CLI version
        run: |
          loofi-fedora-tweaks --cli --version
      - name: Smoke test — CLI help
        run: |
          loofi-fedora-tweaks --cli --help

  build_flatpak:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    continue-on-error: true
    needs: [validate, adapter_drift, lint]
    if: |
      !cancelled() &&
      needs.validate.result == 'success' &&
      needs.lint.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - name: Install Flatpak tools
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
      - name: Add Flathub remote and install SDK
        run: |
          sudo flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y --noninteractive flathub org.kde.Platform//6.6 org.kde.Sdk//6.6
      - name: Build Flatpak
        run: bash scripts/build_flatpak.sh
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: flatpak-package
          path: dist/flatpak/*.flatpak
          if-no-files-found: warn

  build_sdist:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true
    needs: [validate]
    if: |
      !cancelled() &&
      needs.validate.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: ${{ env.PIP_CACHE_FILES }}
      - name: Install build tools
        run: pip install build setuptools wheel
      - name: Build source distribution
        run: bash scripts/build_sdist.sh
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sdist-package
          path: dist/*.tar.gz
          if-no-files-found: warn

  auto_tag:
    if: |
      !cancelled() &&
      needs.build.result == 'success' &&
      needs.rpm_smoke_test.result == 'success' &&
      github.ref == 'refs/heads/master' &&
      (github.event_name != 'workflow_dispatch' || !inputs.dry_run)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    needs: [validate, build, rpm_smoke_test, build_flatpak, build_sdist]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create version tag if missing
        run: |
          TAG="${{ needs.validate.outputs.tag }}"
          git fetch --tags --force origin

          if git ls-remote --exit-code --tags origin "refs/tags/${TAG}" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists. Skipping."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "${TAG}" "${GITHUB_SHA}"
          git push origin "${TAG}"
          echo "Created and pushed ${TAG}"

  release:
    if: |
      !cancelled() &&
      needs.build.result == 'success' &&
      needs.rpm_smoke_test.result == 'success' &&
      (github.event_name != 'workflow_dispatch' || !inputs.dry_run) &&
      (startsWith(github.ref, 'refs/tags/v') ||
       (github.event_name == 'workflow_dispatch' && inputs.version != '') ||
       github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    container: fedora:43
    timeout-minutes: 20
    permissions:
      contents: write
    needs:
      [validate, build, rpm_smoke_test, auto_tag, build_flatpak, build_sdist]
    steps:
      - name: Install release deps
        run: dnf install -y git python3 curl

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if release already exists
        id: check_release
        run: |
          TAG="${{ needs.validate.outputs.tag }}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${TAG}")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Release ${TAG} already exists — skipping publish."
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Download RPM artifact
        if: steps.check_release.outputs.exists != 'true'
        uses: actions/download-artifact@v4
        with:
          name: rpm-package
          path: release-assets

      - name: Download Flatpak artifact
        if: steps.check_release.outputs.exists != 'true'
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: flatpak-package
          path: release-assets

      - name: Download sdist artifact
        if: steps.check_release.outputs.exists != 'true'
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: sdist-package
          path: release-assets

      - name: List release assets
        if: steps.check_release.outputs.exists != 'true'
        run: |
          echo "Release assets:"
          ls -lh release-assets/ 2>/dev/null || echo "No assets found"

      - name: Resolve release tag
        if: steps.check_release.outputs.exists != 'true'
        id: release_meta
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          elif [ -n "${{ inputs.version }}" ]; then
            TAG="v${{ inputs.version }}"
          else
            TAG="${{ needs.validate.outputs.tag }}"
          fi
          VERSION="${TAG#v}"

          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git fetch --tags --force origin
          if ! git rev-parse "refs/tags/${TAG}" >/dev/null 2>&1; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git tag "${TAG}" "${GITHUB_SHA}"
            git push origin "${TAG}"
          fi

          CODENAME=$(python3 -c "import sys; sys.path.insert(0,'loofi-fedora-tweaks'); from version import __version_codename__; print(__version_codename__)" 2>/dev/null || echo "")

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "codename=${CODENAME}" >> "$GITHUB_OUTPUT"

      - name: Generate release body
        if: steps.check_release.outputs.exists != 'true'
        run: |
          TAG="${{ steps.release_meta.outputs.tag }}"
          VERSION="${{ steps.release_meta.outputs.version }}"
          CODENAME="${{ steps.release_meta.outputs.codename }}"
          NOTES_FILE="docs/releases/RELEASE-NOTES-v${VERSION}.md"
          LEGACY_NOTES_FILE="RELEASE-NOTES-v${VERSION}.md"

          if [ -f "$NOTES_FILE" ]; then
            cp "$NOTES_FILE" /tmp/release-body.md
          elif [ -f "$LEGACY_NOTES_FILE" ]; then
            cp "$LEGACY_NOTES_FILE" /tmp/release-body.md
          else
            cat > /tmp/release-body.md <<EOF
          ## Loofi Fedora Tweaks ${TAG}${CODENAME:+ — ${CODENAME}}

          ### Installation
          \`\`\`bash
          pkexec dnf install ./loofi-fedora-tweaks-*.rpm
          \`\`\`

          ### Changes
          See [CHANGELOG](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) for details.
          EOF
          fi

      - name: Publish GitHub Release (idempotent)
        if: steps.check_release.outputs.exists != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_meta.outputs.tag }}
          name: "Loofi Fedora Tweaks ${{ steps.release_meta.outputs.tag }}${{ steps.release_meta.outputs.codename && format(' — {0}', steps.release_meta.outputs.codename) || '' }}"
          body_path: /tmp/release-body.md
          draft: false
          prerelease: ${{ contains(steps.release_meta.outputs.tag, '-rc') || contains(steps.release_meta.outputs.tag, '-beta') || contains(steps.release_meta.outputs.tag, '-alpha') }}
          files: |
            release-assets/*.rpm
            release-assets/*.flatpak
            release-assets/*.AppImage
            release-assets/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        if: always()
        run: |
          TAG="${{ needs.validate.outputs.tag }}"
          if [ "${{ steps.check_release.outputs.exists }}" = "true" ]; then
            echo "::notice::Release ${TAG} already exists — no action taken."
          else
            ASSETS=$(ls release-assets/ 2>/dev/null | tr '\n' ', ' || echo "none")
            echo "::notice::Published release ${TAG} with artifacts: ${ASSETS}"
          fi
