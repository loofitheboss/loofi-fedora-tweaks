name: Auto Release Pipeline

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version without v prefix (example: 25.0.1). Required for manual release runs.'
        required: false
      dry_run:
        description: 'Dry run (validate/build only, skip tag/release publish).'
        type: boolean
        default: false

permissions:
  contents: read

concurrency:
  group: auto-release-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.12'
  PIP_CACHE_FILES: |
    requirements.txt
    .github/workflows/auto-release.yml

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ${{ env.PIP_CACHE_FILES }}

      - name: Resolve version and tag
        id: version
        run: |
          PY_VER=$(python -c "import sys; sys.path.insert(0,'loofi-fedora-tweaks'); from version import __version__; print(__version__)")
          echo "version=${PY_VER}" >> "$GITHUB_OUTPUT"
          echo "tag=v${PY_VER}" >> "$GITHUB_OUTPUT"

      - name: Validate manual release version input
        if: github.event_name == 'workflow_dispatch' && inputs.version != ''
        run: |
          INPUT_VER="${{ inputs.version }}"
          CODE_VER="${{ steps.version.outputs.version }}"
          if [ "$INPUT_VER" != "$CODE_VER" ]; then
            echo "::error::workflow_dispatch version '$INPUT_VER' does not match code version '$CODE_VER'"
            exit 1
          fi

      - name: Validate version alignment
        run: |
          PY_VER="${{ steps.version.outputs.version }}"
          SPEC_VER=$(grep '^Version:' loofi-fedora-tweaks.spec | awk '{print $2}')

          echo "version.py: $PY_VER"
          echo ".spec: $SPEC_VER"

          if [ "$PY_VER" != "$SPEC_VER" ]; then
            echo "::error::Version mismatch! version.py=$PY_VER, .spec=$SPEC_VER"
            exit 1
          fi

          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            TAG_VER="${GITHUB_REF#refs/tags/v}"
            if [ "$PY_VER" != "$TAG_VER" ]; then
              echo "::error::Tag version ($TAG_VER) doesn't match code ($PY_VER)"
              exit 1
            fi
          fi

      - name: Validate workflow logs for release events
        if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
        run: python3 scripts/check_release_docs.py --require-logs

      - name: Validate packaging scripts
        run: |
          for script in scripts/build_rpm.sh scripts/build_flatpak.sh scripts/build_appimage.sh scripts/build_sdist.sh; do
            if [ -f "$script" ]; then
              echo "✓ $script exists"
              if [ -x "$script" ]; then
                echo "  ✓ executable"
              else
                echo "::error::$script exists but is not executable"
                exit 1
              fi
            else
              echo "::error::$script missing"
              exit 1
            fi
          done

  adapter_drift:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ${{ env.PIP_CACHE_FILES }}
      - run: python3 scripts/sync_ai_adapters.py --check

  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ${{ env.PIP_CACHE_FILES }}
      - run: pip install flake8
      - run: flake8 loofi-fedora-tweaks/ --max-line-length=150 --ignore=E501,W503,E402,E722

  typecheck:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ${{ env.PIP_CACHE_FILES }}
      - run: pip install mypy PyQt6-stubs
      - run: mypy loofi-fedora-tweaks/ --ignore-missing-imports --no-error-summary --warn-return-any

  docs_gate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ${{ env.PIP_CACHE_FILES }}
      - run: python3 scripts/check_release_docs.py

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      QT_QPA_PLATFORM: offscreen
    steps:
      - uses: actions/checkout@v4
      - name: Install system test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libegl1
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ${{ env.PIP_CACHE_FILES }}
      - run: pip install -r requirements.txt pytest pytest-cov pytest-timeout PyQt6
      - run: python loofi-fedora-tweaks/main.py --version
      - run: python loofi-fedora-tweaks/main.py --cli --version
      - run: |
          PYTHONPATH=loofi-fedora-tweaks python -m pytest tests/ -v \
            --tb=short \
            --timeout=60 \
            --cov=loofi-fedora-tweaks \
            --cov-report=term-missing \
            --cov-fail-under=50

  security:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ${{ env.PIP_CACHE_FILES }}
      - run: pip install bandit
      - run: bandit -r loofi-fedora-tweaks/ -ll -ii --skip B404,B603,B602 -f json -o bandit-report.json
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: bandit-report.json

  build:
    runs-on: ubuntu-latest
    container: fedora:43
    timeout-minutes: 20
    needs: [validate, adapter_drift, lint, typecheck, docs_gate, test, security]
    steps:
      - uses: actions/checkout@v4
      - name: Install build deps
        run: dnf install -y rpm-build python3
      - name: Build RPM
        run: bash scripts/build_rpm.sh
      - uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: rpmbuild/RPMS/noarch/*.rpm
          if-no-files-found: error

  auto_tag:
    if: github.ref == 'refs/heads/master' && (github.event_name != 'workflow_dispatch' || !inputs.dry_run)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    needs: [validate, adapter_drift, lint, typecheck, docs_gate, test, security, build]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create version tag if missing
        run: |
          TAG="${{ needs.validate.outputs.tag }}"
          git fetch --tags --force origin

          if git ls-remote --exit-code --tags origin "refs/tags/${TAG}" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists. Skipping."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "${TAG}" "${GITHUB_SHA}"
          git push origin "${TAG}"
          echo "Created and pushed ${TAG}"

  release:
    if: (startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.version != '')) && (github.event_name != 'workflow_dispatch' || !inputs.dry_run)
    runs-on: ubuntu-latest
    container: fedora:43
    timeout-minutes: 20
    permissions:
      contents: write
    needs: [validate, adapter_drift, lint, typecheck, docs_gate, test, security, build]
    steps:
      - name: Install release deps
        run: dnf install -y git python3

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download RPM artifact
        uses: actions/download-artifact@v4
        with:
          name: rpm-package
          path: rpmbuild/RPMS/noarch

      - name: Resolve release tag
        id: release_meta
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG="v${{ inputs.version }}"
          fi
          VERSION="${TAG#v}"

          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git fetch --tags --force origin
          if ! git rev-parse "refs/tags/${TAG}" >/dev/null 2>&1; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git tag "${TAG}" "${GITHUB_SHA}"
            git push origin "${TAG}"
          fi

          CODENAME=$(python3 -c "import sys; sys.path.insert(0,'loofi-fedora-tweaks'); from version import __version_codename__; print(__version_codename__)" 2>/dev/null || echo "")

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "codename=${CODENAME}" >> "$GITHUB_OUTPUT"

      - name: Generate release body
        run: |
          TAG="${{ steps.release_meta.outputs.tag }}"
          VERSION="${{ steps.release_meta.outputs.version }}"
          CODENAME="${{ steps.release_meta.outputs.codename }}"
          NOTES_FILE="docs/releases/RELEASE-NOTES-v${VERSION}.md"
          LEGACY_NOTES_FILE="RELEASE-NOTES-v${VERSION}.md"

          if [ -f "$NOTES_FILE" ]; then
            cp "$NOTES_FILE" /tmp/release-body.md
          elif [ -f "$LEGACY_NOTES_FILE" ]; then
            cp "$LEGACY_NOTES_FILE" /tmp/release-body.md
          else
            cat > /tmp/release-body.md <<EOF
          ## Loofi Fedora Tweaks ${TAG}${CODENAME:+ — ${CODENAME}}

          ### Installation
          \`\`\`bash
          pkexec dnf install ./loofi-fedora-tweaks-*.rpm
          \`\`\`

          ### Changes
          See [CHANGELOG](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) for details.
          EOF
          fi

      - name: Publish GitHub Release (idempotent)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_meta.outputs.tag }}
          name: "Loofi Fedora Tweaks ${{ steps.release_meta.outputs.tag }}${{ steps.release_meta.outputs.codename && format(' — {0}', steps.release_meta.outputs.codename) || '' }}"
          body_path: /tmp/release-body.md
          draft: false
          prerelease: ${{ contains(steps.release_meta.outputs.tag, '-rc') || contains(steps.release_meta.outputs.tag, '-beta') || contains(steps.release_meta.outputs.tag, '-alpha') }}
          files: rpmbuild/RPMS/noarch/loofi-fedora-tweaks-${{ steps.release_meta.outputs.version }}*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
