name: Changelog Updater

on:
  pull_request:
    types: [closed]
    branches: [master]

permissions:
  contents: write

jobs:
  update-changelog:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Update CHANGELOG
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = pr.labels.map(l => l.name);
            let category = '### Changed';
            if (labels.includes('bug')) category = '### Fixed';
            if (labels.includes('enhancement')) category = '### Added';
            if (labels.includes('security')) category = '### Security';
            if (labels.includes('docs')) category = '### Documentation';
            if (labels.includes('ci/cd')) category = '### CI/CD';

            const entry = `- ${pr.title} (#${pr.number}) @${pr.user.login}`;
            const fs = require('fs');
            const path = 'CHANGELOG.md';
            
            if (!fs.existsSync(path)) {
              fs.writeFileSync(path, `# Changelog\n\n## [Unreleased]\n\n${category}\n${entry}\n`);
            } else {
              let changelog = fs.readFileSync(path, 'utf8');
              const marker = '## [Unreleased]';
              if (changelog.includes(marker)) {
                const unreleasedStart = changelog.indexOf(marker);
                const nextSectionIndex = changelog.indexOf('\n## ', unreleasedStart + marker.length);
                const beforeUnreleased = changelog.slice(0, unreleasedStart);
                const unreleasedSection = nextSectionIndex === -1
                  ? changelog.slice(unreleasedStart)
                  : changelog.slice(unreleasedStart, nextSectionIndex);
                const afterUnreleased = nextSectionIndex === -1
                  ? ''
                  : changelog.slice(nextSectionIndex);

                let updatedUnreleasedSection;
                if (unreleasedSection.includes(category)) {
                  // Category header already exists in [Unreleased]; add entry under that header.
                  updatedUnreleasedSection = unreleasedSection.replace(
                    category,
                    `${category}\n${entry}`
                  );
                } else {
                  // No category header yet under [Unreleased]; add header and entry.
                  updatedUnreleasedSection = unreleasedSection.replace(
                    marker,
                    `${marker}\n\n${category}\n${entry}`
                  );
                }

                changelog = beforeUnreleased + updatedUnreleasedSection + afterUnreleased;
              } else {
                changelog = `# Changelog\n\n## [Unreleased]\n\n${category}\n${entry}\n\n` + changelog;
              }
              fs.writeFileSync(path, changelog);
            }

      - name: Commit changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git diff --cached --quiet || git commit -m "changelog: add entry for #${{ github.event.pull_request.number }}"
          if ! git push; then
            echo "Warning: git push failed; changelog commit was not pushed." >&2
          fi
