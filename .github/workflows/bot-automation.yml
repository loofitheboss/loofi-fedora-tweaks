name: Bot Automation

on:
  pull_request:
    types: [opened, synchronize, labeled]
    branches: [master]
  push:
    branches:
      - master
      - 'codex/**'
      - 'copilot/**'
      - 'opencode/**'
      - 'agent/**'
  issues:
    types: [opened, labeled]
  schedule:
    - cron: '0 6 * * 1'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  push-status:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Non-blocking push status
        run: echo "Bot Automation is event-driven; push status marked successful."

  auto-label-pr:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner, repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });
            const labels = new Set();
            for (const file of files) {
              const p = file.filename;
              if (p.startsWith('loofi-fedora-tweaks/ui/')) labels.add('ui');
              if (p.startsWith('loofi-fedora-tweaks/utils/')) labels.add('backend');
              if (p.startsWith('loofi-fedora-tweaks/cli/')) labels.add('cli');
              if (p.startsWith('loofi-fedora-tweaks/core/')) labels.add('core');
              if (p.startsWith('loofi-fedora-tweaks/services/')) labels.add('services');
              if (p.startsWith('loofi-fedora-tweaks/api/')) labels.add('api');
              if (p.startsWith('loofi-fedora-tweaks/config/')) labels.add('config');
              if (p.startsWith('tests/')) labels.add('tests');
              if (p.startsWith('.github/')) labels.add('ci/cd');
              if (p.startsWith('docs/')) labels.add('docs');
              if (p.startsWith('scripts/')) labels.add('tooling');
              if (p.includes('security') || p.includes('bandit')) labels.add('security');
              if (p.endsWith('.spec') || p.endsWith('.service') || p.includes('flatpak') || p.includes('appimage')) labels.add('packaging');
            }
            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: [...labels],
              });
            }

  auto-label-issue:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.issue.title.toLowerCase();
            const body = (context.payload.issue.body || '').toLowerCase();
            const text = title + ' ' + body;
            const labels = [];
            if (text.includes('bug') || text.includes('crash') || text.includes('error') || text.includes('broken')) labels.push('bug');
            if (text.includes('feature') || text.includes('request') || text.includes('enhancement') || text.includes('add')) labels.push('enhancement');
            if (text.includes('security') || text.includes('vulnerability') || text.includes('cve')) labels.push('security');
            if (text.includes('ui') || text.includes('tab') || text.includes('widget') || text.includes('gui')) labels.push('ui');
            if (text.includes('cli') || text.includes('command line') || text.includes('terminal')) labels.push('cli');
            if (text.includes('test') || text.includes('coverage') || text.includes('pytest')) labels.push('tests');
            if (text.includes('doc') || text.includes('readme') || text.includes('changelog')) labels.push('docs');
            if (text.includes('rpm') || text.includes('flatpak') || text.includes('appimage') || text.includes('package')) labels.push('packaging');
            if (text.includes('performance') || text.includes('slow') || text.includes('memory')) labels.push('performance');
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: labels,
              });
            }

  stale-cleanup:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/stale@v9
        with:
          days-before-stale: 30
          days-before-close: 14
          stale-issue-label: 'stale'
          stale-pr-label: 'stale'
          stale-issue-message: >
            This issue has been automatically marked as stale because it has not had
            recent activity. It will be closed in 14 days if no further activity occurs.
          stale-pr-message: >
            This PR has been automatically marked as stale because it has not had
            recent activity. It will be closed in 14 days if no further activity occurs.
          exempt-issue-labels: 'roadmap-item,pinned,in-progress'
          exempt-pr-labels: 'roadmap,in-progress,do-not-close'
