name: Stats Freshness Check

on:
    schedule:
        # Weekly on Monday at 06:00 UTC
        - cron: "0 6 * * 1"
    workflow_dispatch:

permissions:
    contents: write
    pull-requests: write

jobs:
    stats-check:
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Generate project stats
              run: python3 scripts/project_stats.py

            - name: Check for drift
              id: drift
              run: |
                  if python3 scripts/project_stats.py --check; then
                    echo "drifted=false" >> "$GITHUB_OUTPUT"
                  else
                    echo "drifted=true" >> "$GITHUB_OUTPUT"
                  fi

            - name: Auto-render templates if drifted
              if: steps.drift.outputs.drifted == 'true'
              run: |
                  python3 scripts/project_stats.py
                  python3 scripts/sync_ai_adapters.py --render
                  python3 scripts/sync_ai_adapters.py

            - name: Create PR for stats update
              if: steps.drift.outputs.drifted == 'true'
              run: |
                  BRANCH="auto/stats-refresh-$(date +%Y%m%d)"
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

                  # Check if there are actual file changes
                  if git diff --quiet && git diff --cached --quiet; then
                    echo "No file changes after render â€” skipping PR."
                    exit 0
                  fi

                  git checkout -b "$BRANCH"
                  git add -A
                  git commit -m "chore: auto-refresh project stats and templates"
                  git push origin "$BRANCH"

                  gh pr create \
                    --title "chore: refresh project stats (auto)" \
                    --body "## Stats Drift Detected

                  The weekly stats freshness check found that committed agent/instruction files
                  have stale values. This PR re-renders templates with current stats from
                  \`.project-stats.json\`.

                  **Auto-generated by stats-freshness workflow.**" \
                    --label "automation" \
                    --base master \
                    --head "$BRANCH"
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Show stats summary
              run: python3 scripts/project_stats.py --markdown
